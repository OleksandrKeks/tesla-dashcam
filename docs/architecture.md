# Архітектура системи

## Огляд

Система складається з Raspberry Pi 4B як центрального контролера,
4 USB камер для відеозйомки, 4G USB донгла для інтернету,
акселерометра MPU6050 для детекції ударів, та microSD карти для запису.

## Режими роботи

### 1. Режим запису (Dashcam)
- Безперервний циклічний запис з усіх 4 камер
- Файли по 5 хвилин, H.264 кодек
- Автовидалення найстаріших файлів при заповненні диска
- Timestamp в кожному кадрі

### 2. Режим охорони (Sentry)
- Активується коли авто запарковано (детекція через акселерометр)
- Камери в режимі детекції руху (Motion)
- При спрацюванні:
  1. Зберігає відео (10 сек до + 30 сек після події)
  2. Надсилає GIF/фото в Telegram
  3. Починає стрім з камери що спрацювала

### 3. Режим удару (Impact)
- MPU6050 постійно моніторить вібрації
- При різкому прискоренні > порогу:
  1. Зберігає відео з усіх камер (30 сек до + 60 сек після)
  2. Надсилає сповіщення в Telegram з GPS (якщо є)
  3. Відео позначається як "захищене" (не видаляється)

### 4. Режим стріму (Live View)
- Через Telegram бот: команда /live → вибір камери → MJPEG стрім
- Через веб-інтерфейс: мозаїка з 4 камер
- Доступ через Tailscale VPN або Telegram

## Програмні компоненти

### recorder.py — Запис відео
- FFmpeg для кожної камери в окремому процесі
- Сегментація: 5 хв файли, H.264, 1080p@15fps
- Циклічний буфер: зберігає останні N годин
- Watermark з датою/часом

### sentry.py — Детекція руху
- OpenCV / Motion для аналізу кадрів
- Налаштовувана чутливість та зони
- Фільтрація хибних спрацювань (вітер, дощ, тіні)
- Буфер: зберігає останні 10 сек для pre-event запису

### impact.py — Детекція ударів
- Python + smbus2 для читання MPU6050 через I2C
- Поріг спрацювання: налаштовується
- Інтеграція з recorder для збереження кліпу

### telegram_bot.py — Telegram бот
- Inline кнопки для керування
- Команди: /live, /status, /clip, /sentry on/off
- Надсилання GIF при подіях
- Стрім через Telegram (фото кожні 2 сек або відео-ноти)

### web_server.py — Веб-інтерфейс
- Flask / FastAPI
- Мозаїка з 4 камер (MJPEG)
- Архів записів з пошуком по часу
- Налаштування системи

## Автозапуск
- systemd сервіси для кожного компонента
- Watchdog для перезапуску при збоях
- Graceful shutdown при зниканні живлення (UPS)
